---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
  bookdown::odt_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bib.bib")`'
---

```{r setup, include=FALSE}
# Log compile time:
startTime <- proc.time()

knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
#knitr::opts_chunk$set(results = "asis") # fixes html table for Word

require(data.table)
require(ggplot2)
require(hms)
require(kableExtra)
require(lubridate)
require(skimr)
```

# Introduction

Exploration of various data sets on a set of residential `virtual power plant` installations. These have PV, batteries and hot water controllers.

# Code

See https://github.com/CfSOtago/vpp/tree/master/scripts

# To do

See the repo [issues list](https://github.com/CfSOtago/vpp/issues).
 
# Test Data

This will fail if you are not connected to the University of Otago HCS service where the data is archived.

## RgAv_Sample_Data.csv.gz


```{r loadRgAv}

dt1 <- drake::readd(df1)  # retrieve from wherever drake put it
```


This data appears to be regional averages. We don't know how many dwellings are covered in each region.

The following shows the original variable names and descriptives.

```{r skimRgAv}
skimr::skim(dt1)
```

Table \@ref(tab:headRgAv) shows the first 10 rows of data.

```{r headRgAv}
dt1[, dateTime := lubridate::as_datetime(`record time utc`)]
dt1[, dateTimeNZ := lubridate::with_tz(dateTime, tzone = "Pacific/Auckland")] # fix time zone

setkey(dt1, region, dateTimeNZ)
t <- head(dt1[region == "Auckland"], 10)

kableExtra::kable(t, caption = "First 10 rows for Auckland ordered by dateTime NZ") %>%
  kable_styling()
```


 * N observations: `r nrow(dt1)`
 * Dates range: `r min(dt1$dateTimeNZ)` to `r max(dt1$dateTimeNZ)`
 
There is no obvous pattern to the sequence of time stamps (Figure \@ref(fig:datesDiff)) although it appears that there are pairs of observations close together Table \@ref(tab:headRgAv).

```{r datesDiff, fig.cap="Density plot of time difference between sequantial observations (all data < 30 minutes)"}
setkey(dt1, region, dateTimeNZ)
dt1[, datesDiff := dateTimeNZ - shift(dateTimeNZ), keyby = .(region)] # intervals within regions

skimr::skim(dt1$datesDiff)

ggplot(dt1[datesDiff < 30*60], aes(x = datesDiff, colour = region)) +
  geom_density()
```

Figure \@ref(fig:plotRegionsRgAv) shows the number of observations per day and presumably increases with the number of households in the sample? In which case what are the data points an average of?

```{r plotRegionsRgAv, fig.cap="N daily observations by region egion"}
plotDT <- dt1[, .(nObs = .N), keyby = .(date = lubridate::date(dateTimeNZ), region)]

ggplot2::ggplot(plotDT, aes(x = date, y = nObs, colour = region)) +
  geom_line() +
  labs(x = "Date",
       y = "N observations",
       caption = paste0("RgAv data from ", min(plotDT$date), " to ", max(plotDT$date)
                        )
  )
```

Figure \@ref(fig:plotRegionsSolarRgAv) shows the mean solar electricity generated per day over time.

```{r plotRegionsSolarRgAv, fig.cap="Mean daily solar electricity generated by region"}
plotDT <- dt1[, .(nObs = .N,
                  meanSolar = mean(`solar electricity generated`)), keyby = .(date = lubridate::date(dateTimeNZ), region)]

ggplot2::ggplot(plotDT, aes(x = date, y = meanSolar, colour = region)) +
  geom_line() +
  labs(x = "Date",
       y = "Mean solar gen",
       caption = paste0("RgAv data from ", min(plotDT$date), " to ", max(plotDT$date)
                        )
  )
```

Figure \@ref(fig:plotRegionsSolarProfileRgAv) shows the mean solar electricity generated by time of day for December and January only. It appears to make sense.

```{r plotRegionsSolarProfileRgAv, fig.cap="Mean solar generation by time of day and region"}
dt1[, hms := hms::as_hms(dateTimeNZ)]
dt1[, halfHour := hms::trunc_hms(hms, 30*60)]
dt1[, month := lubridate::month(dateTimeNZ, label = TRUE, abbr = TRUE)]
plotDT <- dt1[month == "Dec" | month == "Jan", .(nObs = .N,
                  meanSolar = mean(`solar electricity generated`)), 
              keyby = .(halfHour, region)]

ggplot2::ggplot(plotDT, aes(x = halfHour, y = meanSolar, colour = region)) +
  geom_line() +
  labs(x = "Time of day (half hour)",
       y = "Mean solar gen",
       caption = paste0("RgAv data from ", min(dt1$dateTimeNZ), " to ", max(dt1$dateTimeNZ)
                        )
  )
```


## Sample Monitoring Data.csv.gz

```{r loadSample}

dt2 <- drake::readd(df2) # retrieve from wherever drake put it
```

This data appears to be a sample of the household level monitoring data. It appears to cover `r uniqueN(dt2$Site)` differet `Sites`.

The following shows the original variable names and descriptives.

```{r skimSample}
skimr::skim(dt2)
```


```{r headSample}
dt2[, dateTime := lubridate::dmy_hm(RecordDateTimeUTC)]
dt2[, dateTimeNZ := lubridate::with_tz(dateTime, tzone = "Pacific/Auckland")] # fix time zone

setkey(dt2, Site, dateTimeNZ)
t <- head(dt2, 10)

kableExtra::kable(t, caption = "First 10 rows ordered by dateTime NZ") %>%
  kable_styling()
```

These appear to be 15 minute observations:

 * N sites: `r uniqueN(dt2$Site)`
 * N observations: `r nrow(dt2)`
 * Dates range: `r min(dt2$dateTimeNZ)` to `r max(dt2$dateTimeNZ)`

Figure \@ref(fig:plotSites) shows the number of sites per day. We clearly have just one day of data!

```{r plotSites, fig.cap="N sites by date"}
plotDT <- dt2[, .(nObs = uniqueN(Site)), keyby = .(date = lubridate::date(dateTimeNZ))]

ggplot2::ggplot(plotDT, aes(x = date, y = nObs)) +
  geom_point() +
  labs(x = "Date",
       y = "N sites",
       caption = paste0("Sample data from ", min(plotDT$date), " to ", max(plotDT$date)
                        )
  )
```

Figure \@ref(fig:plotSolarGen) shows the mean solar electricity generated per half-hour by each site. There may be some outliers or data errors...

```{r plotSolarGen, fig.cap="Mean solar generated (legend hidden for clarity)"}
dt2[, hms := hms::as_hms(dateTimeNZ)]
dt2[, halfHour := hms::trunc_hms(hms, 30*60)]
plotDT <- dt2[, .(nObs = .N,
                  meanSolarGen = mean(SolarElectricityGenerated),
                  meanSolarExp = mean(SolarElectricityExported)), keyby = .(halfHour, Site)]
plotDT[, outlier := ifelse(meanSolarGen > 4, "Outlier", "Not an outlier")]

ggplot2::ggplot(plotDT, aes(x = halfHour, y = meanSolarGen, colour = as.factor(Site))) +
  geom_point() +
  theme(legend.position = "none") +
  facet_grid(outlier ~ ., scales = "free") +
  labs(x = "Time of day (half hour)",
       y = "Mean solar gen",
       caption = paste0("Sample data from ", min(dt2$dateTimeNZ), " to ", max(dt2$dateTimeNZ)
                        )
  )
```

Figure \@ref(fig:plotSolarExp) shows the mean solar electricity exported by time of day.

```{r plotSolarExp, fig.cap="Mean exported per site (legend hidden for clarity)"}
ggplot2::ggplot(plotDT, aes(x = halfHour, y = meanSolarExp, colour = as.factor(Site))) +
  geom_point() +
  theme(legend.position = "none") +
  facet_grid(outlier ~ ., scales = "free") +
  labs(x = "Time of day (half hour)",
       y = "Mean solar exp",
       caption = paste0("Sample data from ", min(dt2$dateTimeNZ), " to ", max(dt2$dateTimeNZ)
                        )
  )
```


# About

R packages used:

 * base R [baseR]
 * data.table [@data.table]
 * drake [@drake]
 * ggplt2 [@ggplot2]
 * hms [*hms]
 * kableExtra [@kableExtra]
 * lubridate [@lubridate]
 * skimr [@skimr]

Plus:

 * bookdown [@bookdown]
 * knitr [@knitr]

```{r check.runtime}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r elapsed` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# References